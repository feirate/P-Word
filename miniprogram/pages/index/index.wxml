<!--index.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  - æ¸¸æˆåŒ–æ”¹è¿› -->
  <view class="status-bar">
    <view class="user-info">
      <view class="avatar-wrapper">
        <text class="avatar-icon">ğŸµ</text>
      </view>
      <view class="date-info">
        <text class="date">{{currentDate}}</text>
        <text class="streak-info text-secondary">
          <text class="fire-icon">ğŸ”¥</text>
          è¿ç»­ {{practiceStreak || 0}} å¤©
        </text>
      </view>
    </view>
    
    <!-- äº‘åŒæ­¥çŠ¶æ€ -->
    <view class="sync-status" bindtap="manualSync">
      <text class="sync-icon">{{syncStatus.isOnline ? 'â˜ï¸' : 'ğŸ“±'}}</text>
      <text class="sync-queue" wx:if="{{syncStatus.queueLength > 0}}">{{syncStatus.queueLength}}</text>
    </view>
    
    <!-- è®¾ç½®æŒ‰é’® -->
    <view class="settings-btn" bindtap="goToSettings">
      <text class="icon">âš™ï¸</text>
    </view>
  </view>

  <!-- åŒæ­¥æŒ‡ç¤ºå™¨ -->
  <view class="sync-indicator" wx:if="{{showSyncIndicator}}">
    <text class="indicator-icon">{{syncIndicator.icon}}</text>
    <text class="indicator-text">{{syncIndicator.text}}</text>
  </view>

  <!-- ä»Šæ—¥ç›®æ ‡è¿›åº¦å¡ç‰‡ -->
  <view class="daily-goal-card card">
    <view class="goal-header">
      <view class="goal-info">
        <text class="goal-icon">â­</text>
        <text class="goal-title">ä»Šæ—¥ç›®æ ‡</text>
      </view>
      <text class="goal-progress">{{practiceStats.sentenceCount}}/{{dailyGoal || 20}} å¥</text>
    </view>
    
    <!-- ç¯å½¢è¿›åº¦æ¡ -->
    <view class="progress-ring-container">
      <canvas 
        type="2d"
        canvas-id="progressRing" 
        id="progressRing"
        class="progress-ring"
        style="width: 80px; height: 80px;"
      ></canvas>
      <view class="progress-percentage">
        <text class="percentage-number">{{goalPercentage}}%</text>
      </view>
    </view>
    
    <!-- ä»Šæ—¥æˆå°± -->
    <view class="today-achievements" wx:if="{{todayAchievements.length > 0}}">
      <text class="achievement-text">ğŸ‰ æ–°æˆå°±</text>
      <scroll-view class="achievement-scroll" scroll-x>
        <view class="achievement-badge" 
              wx:for="{{todayAchievements}}" 
              wx:key="id">
          <text class="badge-icon">{{item.icon}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- å¥å­æ˜¾ç¤ºåŒºåŸŸ - ä¼˜åŒ–å¸ƒå±€ -->
  <view class="sentence-area card">
    <view class="sentence-header">
      <view class="level-badge">
        <text class="level-icon">ğŸ“š</text>
        <text class="sentence-level">{{currentSentence.level}}</text>
      </view>
      <text class="sentence-count">{{currentIndex + 1}}/{{totalSentences}}</text>
      
      <!-- æ¨èæ¨¡å¼åˆ‡æ¢ -->
      <view class="recommendation-mode" bindtap="toggleRecommendationMode">
        <text class="mode-icon">
          {{recommendationMode === 'smart' ? 'ğŸ§ ' : recommendationMode === 'category' ? 'ğŸ“‚' : 'ğŸ”€'}}
        </text>
      </view>
    </view>
    
    <view class="sentence-content">
      <view class="sentence-main">
        <text class="sentence-text">{{currentSentence.content}}</text>
        
        <!-- æœ—è¯»æŒ‰é’® -->
        <view class="tts-button {{isTTSPlaying ? 'playing' : ''}}" bindtap="playTextToSpeech">
          <icon 
            name="{{isTTSPlaying ? 'volume-on' : 'volume-off'}}" 
            size="28" 
            color="white"
          />
        </view>
      </view>
      
      <!-- å¥å­åˆ†ç±»æ ‡ç­¾ -->
      <view class="sentence-tags" wx:if="{{currentSentence.category}}">
        <view class="category-tag">
          <text class="tag-icon">ğŸ“‚</text>
          <text>{{currentSentence.category}}</text>
        </view>
        <view class="difficulty-tag" wx:if="{{currentSentence.difficulty}}">
          <text class="difficulty-stars">{{difficultyStars}}</text>
        </view>
      </view>
    </view>
    
    <!-- ç¿»è¯‘ï¼ˆå¯å±•å¼€ï¼‰ -->
    <view class="translation" wx:if="{{showTranslation}}">
      <text class="translation-text text-secondary">{{currentSentence.translation}}</text>
    </view>
    
    <!-- åˆ†ç±»ç­›é€‰ï¼ˆå½“æ¨¡å¼ä¸ºcategoryæ—¶æ˜¾ç¤ºï¼‰ -->
    <view class="category-filter" wx:if="{{recommendationMode === 'category'}}">
      <scroll-view class="category-scroll" scroll-x>
        <view class="category-item {{selectedCategory === '' ? 'active' : ''}}" 
              bindtap="selectCategory" data-category="">
          <text>å…¨éƒ¨</text>
        </view>
        <view class="category-item {{selectedCategory === item ? 'active' : ''}}" 
              wx:for="{{availableCategories}}" 
              wx:key="*this"
              bindtap="selectCategory" 
              data-category="{{item}}">
          <text>{{item}}</text>
        </view>
      </scroll-view>
    </view>
    
    <!-- å±•å¼€ç¿»è¯‘æŒ‰é’® -->
    <view class="expand-btn" bindtap="toggleTranslation">
      <text class="expand-icon">{{showTranslation ? 'ğŸ”¼' : 'ğŸ”½'}}</text>
      <text class="text-secondary">{{showTranslation ? 'æ”¶èµ·' : 'æ˜¾ç¤º'}}ç¿»è¯‘</text>
    </view>
  </view>

  <!-- æ³¢å½¢å¯è§†åŒ–åŒºåŸŸ - å£°æ³¢ä¸»é¢˜ä¼˜åŒ– -->
  <view class="wave-container">
    <view class="wave-header">
      <text class="wave-title">ğŸµ å£°æ³¢å½•åˆ¶</text>
      <text class="wave-quality" wx:if="{{audioQuality}}">è´¨é‡: {{audioQuality.quality}}åˆ†</text>
    </view>
    
    <canvas 
      type="2d"
      canvas-id="waveCanvas" 
      id="waveCanvas"
      class="wave-canvas"
      style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
    ></canvas>
    
    <!-- å½•éŸ³æ—¶é•¿æ˜¾ç¤º -->
    <view class="record-time" wx:if="{{isRecording || recordDuration > 0}}">
      <text class="time-icon">â±ï¸</text>
      <text>{{recordDurationText}}</text>
    </view>
    
    <!-- å½•éŸ³è´¨é‡æ˜¾ç¤º -->
    <view class="audio-quality" wx:if="{{audioQuality}}">
      <view class="quality-header" bindtap="toggleQualityTip">
        <text class="quality-score">ğŸµ è´¨é‡è¯„åˆ†: {{audioQuality.quality}}åˆ†</text>
        <text class="quality-toggle">{{showQualityTip ? 'â–²' : 'â–¼'}}</text>
      </view>
      
      <!-- è¯¦ç»†è´¨é‡ä¿¡æ¯ -->
      <view class="quality-details" wx:if="{{showQualityTip}}">
        <view class="quality-item">
          <text class="quality-label">å¹³å‡éŸ³é‡</text>
          <view class="quality-bar">
            <view class="quality-fill" style="width: {{audioQuality.avgVolume}}%"></view>
          </view>
          <text class="quality-value">{{audioQuality.avgVolume}}%</text>
        </view>
        
        <view class="quality-item">
          <text class="quality-label">éŸ³é‡ç¨³å®šæ€§</text>
          <view class="quality-bar">
            <view class="quality-fill" style="width: {{audioQuality.stability}}%"></view>
          </view>
          <text class="quality-value">{{audioQuality.stability}}%</text>
        </view>
        
        <view class="quality-item" wx:if="{{audioQuality.silenceRatio > 20}}">
          <text class="quality-label">é™éŸ³æ¯”ä¾‹</text>
          <view class="quality-bar warning">
            <view class="quality-fill" style="width: {{audioQuality.silenceRatio}}%"></view>
          </view>
          <text class="quality-value">{{audioQuality.silenceRatio}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å½•éŸ³æ§åˆ¶åŒºåŸŸ - ç°ä»£åŒ–è®¾è®¡ -->
  <view class="record-controls">
    <!-- ä¸»å½•éŸ³æŒ‰é’® -->
    <view class="record-button-container">
      <button 
        class="record-btn {{isRecording ? 'recording' : ''}} {{!recordAuth ? 'disabled' : ''}}"
        bindtouchstart="startRecording"
        bindtouchend="stopRecording"
        disabled="{{!recordAuth}}"
      >
        <!-- å½•éŸ³æ³¢çº¹åŠ¨ç”»èƒŒæ™¯ -->
        <view class="record-ripple" wx:if="{{isRecording}}"></view>
        <view class="record-ripple delay-1" wx:if="{{isRecording}}"></view>
        <view class="record-ripple delay-2" wx:if="{{isRecording}}"></view>
        
        <view class="record-icon">
          <icon 
            wx:if="{{!isRecording}}"
            name="mic" 
            size="32" 
            color="white"
          />
          <icon 
            wx:else
            name="square" 
            size="32" 
            color="white"
          />
        </view>
        <text class="record-text">
          {{isRecording ? 'å½•éŸ³ä¸­...' : (recordAuth ? 'æŒ‰ä½è¯´è¯' : 'éœ€è¦å½•éŸ³æƒé™')}}
        </text>
      </button>
    </view>

    <!-- æ“ä½œæŒ‰é’®ç»„ -->
    <view class="action-buttons">
      <!-- æ’­æ”¾æŒ‰é’® -->
      <button 
        class="action-btn play-btn" 
        bindtap="playRecording"
        disabled="{{!hasRecording}}"
      >
        <view class="action-icon">
          <icon name="play" size="20" color="#2196F3" />
        </view>
        <text class="action-text">æ’­æ”¾</text>
      </button>

      <!-- ä¸‹ä¸€å¥æŒ‰é’® -->
      <button class="action-btn next-btn" bindtap="switchSentence">
        <view class="action-icon">
          <icon name="skip-forward" size="20" color="#2196F3" />
        </view>
        <text class="action-text">ä¸‹ä¸€å¥</text>
      </button>

      <!-- é‡æ–°å½•éŸ³æŒ‰é’® -->
      <button 
        class="action-btn retry-btn" 
        bindtap="reRecord"
        disabled="{{!hasRecording}}"
      >
        <view class="action-icon">
          <icon name="rotate-ccw" size="20" color="#2196F3" />
        </view>
        <text class="action-text">é‡å½•</text>
      </button>
    </view>
  </view>

  <!-- ç»ƒä¹ ç»Ÿè®¡ - æ¸¸æˆåŒ–å±•ç¤º -->
  <view class="practice-stats card">
    <view class="stats-title">
      <view class="stats-icon">
        <icon name="audio-waveform" size="24" color="#2196F3" />
      </view>
      <text>ä»Šæ—¥ç»ƒä¹ æŠ¥å‘Š</text>
    </view>
    
    <view class="stats-row">
      <view class="stats-item">
        <view class="stats-icon">
          <icon name="mic" size="20" color="#4CAF50" />
        </view>
        <text class="stats-number">{{practiceStats.sentenceCount}}</text>
        <text class="stats-label">å®Œæˆå¥æ•°</text>
      </view>
      <view class="stats-divider"></view>
      <view class="stats-item">
        <text class="stats-icon">â±ï¸</text>
        <text class="stats-number">{{practiceStats.totalTime}}</text>
        <text class="stats-label">ç»ƒä¹ æ—¶é•¿</text>
      </view>
      <view class="stats-divider"></view>
      <view class="stats-item">
        <text class="stats-icon">ğŸ†</text>
        <text class="stats-number">{{practiceStats.bestScore || '--'}}</text>
        <text class="stats-label">æœ€ä½³è¯„åˆ†</text>
      </view>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œåŒºåŸŸ -->
  <view class="quick-actions card">
    <view class="quick-btn" bindtap="goToHistory">
      <text class="quick-icon">ğŸ“ˆ</text>
      <text class="quick-text">ç»ƒä¹ å†å²</text>
    </view>
    <view class="quick-btn" bindtap="goToLibrary">
      <text class="quick-icon">ğŸ“š</text>
      <text class="quick-text">è¯­æ–™åº“</text>
    </view>
    <view class="quick-btn" bindtap="sharePractice">
      <text class="quick-icon">ğŸ“¤</text>
      <text class="quick-text">åˆ†äº«ç»ƒä¹ </text>
    </view>
  </view>
</view> 