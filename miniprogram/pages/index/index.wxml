<!--index.wxml-->
<view class="container">
  <!-- 顶部状态栏 -->
  <view class="status-bar">
    <view class="date-info">
      <text class="date">{{currentDate}}</text>
      <text class="practice-time text-secondary">今日练习 {{todayPracticeTime}} 分钟</text>
    </view>
    
    <!-- 设置按钮 -->
    <view class="settings-btn" bindtap="goToSettings">
      <text class="icon">⚙️</text>
    </view>
  </view>

  <!-- 句子显示区域 -->
  <view class="sentence-area card">
    <view class="sentence-header">
      <text class="sentence-level">{{currentSentence.level}}</text>
      <text class="sentence-count">{{currentIndex + 1}}/{{totalSentences}}</text>
      
      <!-- 推荐模式切换 -->
      <view class="recommendation-mode" bindtap="toggleRecommendationMode">
        <text class="mode-icon">
          {{recommendationMode === 'smart' ? '🧠' : recommendationMode === 'category' ? '📂' : '🔀'}}
        </text>
      </view>
    </view>
    
    <view class="sentence-content">
      <text class="sentence-text">{{currentSentence.content}}</text>
      
      <!-- 句子分类标签 -->
      <view class="sentence-tags" wx:if="{{currentSentence.category}}">
        <text class="category-tag">{{currentSentence.category}}</text>
        <text class="difficulty-tag" wx:if="{{currentSentence.difficulty}}">
          难度{{currentSentence.difficulty}}
        </text>
      </view>
    </view>
    
    <!-- 翻译（可展开） -->
    <view class="translation" wx:if="{{showTranslation}}">
      <text class="translation-text text-secondary">{{currentSentence.translation}}</text>
    </view>
    
    <!-- 分类筛选（当模式为category时显示） -->
    <view class="category-filter" wx:if="{{recommendationMode === 'category'}}">
      <scroll-view class="category-scroll" scroll-x>
        <view class="category-item {{selectedCategory === '' ? 'active' : ''}}" 
              bindtap="selectCategory" data-category="">
          <text>全部</text>
        </view>
        <view class="category-item {{selectedCategory === item ? 'active' : ''}}" 
              wx:for="{{availableCategories}}" 
              wx:key="*this"
              bindtap="selectCategory" 
              data-category="{{item}}">
          <text>{{item}}</text>
        </view>
      </scroll-view>
    </view>
    
    <!-- 展开翻译按钮 -->
    <view class="expand-btn" bindtap="toggleTranslation">
      <text class="text-secondary">{{showTranslation ? '收起' : '显示'}}翻译</text>
    </view>
  </view>

  <!-- 波形可视化区域 -->
  <view class="wave-container">
    <canvas 
      canvas-id="waveCanvas" 
      id="waveCanvas"
      class="wave-canvas"
      style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
    ></canvas>
    
    <!-- 录音时长显示 -->
    <view class="record-time" wx:if="{{isRecording || recordDuration > 0}}">
      <text>{{recordDurationText}}</text>
    </view>
    
    <!-- 录音质量显示 -->
    <view class="audio-quality" wx:if="{{audioQuality}}">
      <view class="quality-header" bindtap="toggleQualityTip">
        <text class="quality-score">🎵 质量评分: {{audioQuality.quality}}分</text>
        <text class="quality-toggle">{{showQualityTip ? '▲' : '▼'}}</text>
      </view>
      
      <!-- 详细质量信息 -->
      <view class="quality-details" wx:if="{{showQualityTip}}">
        <view class="quality-item">
          <text class="quality-label">平均音量</text>
          <view class="quality-bar">
            <view class="quality-fill" style="width: {{audioQuality.avgVolume}}%"></view>
          </view>
          <text class="quality-value">{{audioQuality.avgVolume}}%</text>
        </view>
        
        <view class="quality-item">
          <text class="quality-label">音量稳定性</text>
          <view class="quality-bar">
            <view class="quality-fill" style="width: {{audioQuality.stability}}%"></view>
          </view>
          <text class="quality-value">{{audioQuality.stability}}%</text>
        </view>
        
        <view class="quality-item" wx:if="{{audioQuality.silenceRatio > 20}}">
          <text class="quality-label">静音比例</text>
          <view class="quality-bar warning">
            <view class="quality-fill" style="width: {{audioQuality.silenceRatio}}%"></view>
          </view>
          <text class="quality-value">{{audioQuality.silenceRatio}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 录音控制区域 -->
  <view class="record-controls">
    <!-- 主录音按钮 -->
    <view class="record-button-container">
      <button 
        class="record-btn {{isRecording ? 'recording' : ''}} {{!recordAuth ? 'disabled' : ''}}"
        bindtouchstart="startRecording"
        bindtouchend="stopRecording"
        disabled="{{!recordAuth}}"
      >
        <view class="record-icon">
          <text wx:if="{{!isRecording}}">🎙️</text>
          <text wx:else class="recording-icon">⏹️</text>
        </view>
        <text class="record-text">
          {{isRecording ? '录音中' : (recordAuth ? '按住录音' : '需要权限')}}
        </text>
      </button>
    </view>

    <!-- 操作按钮组 -->
    <view class="action-buttons">
      <!-- 播放按钮 -->
      <button 
        class="action-btn" 
        bindtap="playRecording"
        disabled="{{!hasRecording}}"
      >
        <text class="action-icon">▶️</text>
        <text class="action-text">播放</text>
      </button>

      <!-- 下一句按钮 -->
      <button class="action-btn" bindtap="switchSentence">
        <text class="action-icon">⏭️</text>
        <text class="action-text">下一句</text>
      </button>

      <!-- 重新录音按钮 -->
      <button 
        class="action-btn" 
        bindtap="reRecord"
        disabled="{{!hasRecording}}"
      >
        <text class="action-icon">🔄</text>
        <text class="action-text">重录</text>
      </button>
    </view>
  </view>

  <!-- 练习统计 -->
  <view class="practice-stats card">
    <view class="stats-item">
      <text class="stats-number">{{practiceStats.sentenceCount}}</text>
      <text class="stats-label">今日句数</text>
    </view>
    <view class="stats-divider"></view>
    <view class="stats-item">
      <text class="stats-number">{{practiceStats.totalTime}}</text>
      <text class="stats-label">总时长</text>
    </view>
    <view class="stats-divider"></view>
    <view class="stats-item">
      <text class="stats-number">{{practiceStats.bestScore || '--'}}</text>
      <text class="stats-label">最佳评分</text>
    </view>
  </view>

  <!-- 权限申请提示 -->
  <view class="auth-modal" wx:if="{{showAuthModal}}">
    <view class="auth-content">
      <text class="auth-title">需要录音权限</text>
      <text class="auth-desc">请允许使用麦克风进行口语练习</text>
      <view class="auth-buttons">
        <button class="btn btn-secondary" bindtap="hideAuthModal">取消</button>
        <button class="btn btn-primary" bindtap="requestAuth">授权</button>
      </view>
    </view>
  </view>
</view> 